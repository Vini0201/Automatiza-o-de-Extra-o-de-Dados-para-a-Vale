import os
import fitz  # PyMuPDF
from PIL import Image
import pytesseract
import re
from openpyxl import load_workbook, Workbook

# Configuração do Tesseract para Windows
pytesseract.pytesseract.tesseract_cmd = r'C:\\Users\\Vinicius.cunha\\AppData\\Local\\Programs\\Tesseract-OCR\\tesseract.exe'

# Caminhos
input_folder = r"C:\Users\Vinicius.cunha\Music\Extract_PDF\pdfs"
output_folder = r"C:\Users\Vinicius.cunha\Music\Extract_PDF\prints"
excel_path = r"C:\Users\Vinicius.cunha\OneDrive - Eneva S.A\FATURAMENTO VALE - BACK\2025\Resumo_Faturamento VALE_MAI25.xlsx"

# Criar pasta de prints se não existir
os.makedirs(output_folder, exist_ok=True)

# Índices corretos dos números desejados
indices_desejados = [0, 1, 3, 4, 5, 7]

# Função para processar PDF e gerar imagem do trecho correto
def process_pdf(pdf_path, output_image_path):
    try:
        doc = fitz.open(pdf_path)
        page = doc[0]
        area = fitz.Rect(250, 320, 350, 500)
        pix = page.get_pixmap(clip=area, dpi=400)
        img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
        img.save(output_image_path)
        return True
    except Exception as e:
        print(f"Erro ao processar {pdf_path}: {e}")
        return False

# Função para extrair números do print gerado
def extrair_numeros_destaques(image_path):
    try:
        img = Image.open(image_path)
        texto = pytesseract.image_to_string(img, lang='por')
        numeros = re.findall(r'\d+,\d+|\d+', texto)
        return numeros
    except Exception as e:
        print(f"Erro ao processar {image_path}: {e}")
        return []

# Função para salvar no Excel
def save_to_excel(numeros_extraidos, excel_path, nome_pdf):
    if not numeros_extraidos:
        return

    numeros_selecionados = [numeros_extraidos[i] for i in indices_desejados if i < len(numeros_extraidos)]
    if not numeros_selecionados:
        return

    if os.path.exists(excel_path):
        workbook = load_workbook(excel_path)
        sheet = workbook.active
    else:
        workbook = Workbook()
        sheet = workbook.active

    linha = 12
    while sheet.cell(row=linha, column=9).value is not None:
        linha += 1

    for i, numero in enumerate(numeros_selecionados):
        sheet.cell(row=linha, column=9 + i).value = numero
    sheet.cell(row=linha, column=8).value = nome_pdf

    workbook.save(excel_path)
    print(f"Números salvos do arquivo: {nome_pdf}")

# Ordenar arquivos em ordem alfabética (como o Explorer mostra por padrão)
pdf_files = sorted([
    f for f in os.listdir(input_folder)
    if f.lower().endswith(".pdf")
])

if not pdf_files:
    print("Nenhum PDF encontrado na pasta.")
else:
    print(f"Total de PDFs encontrados: {len(pdf_files)}")
    for index, pdf_filename in enumerate(pdf_files):
        pdf_path = os.path.join(input_folder, pdf_filename)
        output_image_path = os.path.join(output_folder, f"destaque_{index}.png")

        if process_pdf(pdf_path, output_image_path):
            numeros_extraidos = extrair_numeros_destaques(output_image_path)
            save_to_excel(numeros_extraidos, excel_path, pdf_filename)



print("Processamento concluído. Imagens temporárias removidas.")
